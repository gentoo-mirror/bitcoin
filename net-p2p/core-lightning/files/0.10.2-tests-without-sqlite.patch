From 23453087b35b51bf9d728f02172ec4458d7a58ee Mon Sep 17 00:00:00 2001
From: Rusty Russell <rusty@rustcorp.com.au>
Date: Mon, 28 Mar 2022 10:58:12 +1030
Subject: [PATCH] [backport] unit tests: don't crash if !HAVE_SQLITE3.

Fixes: #4928
Reported-by: @whitslack
Signed-off-by: Rusty Russell <rusty@rustcorp.com.au>
---
 wallet/test/run-db.c     |  9 ++++++---
 wallet/test/run-wallet.c | 21 ++++++++++++---------
 2 files changed, 18 insertions(+), 12 deletions(-)

diff --git a/wallet/test/run-db.c b/wallet/test/run-db.c
index 92ae8a87a..0805ab63b 100644
--- a/wallet/test/run-db.c
+++ b/wallet/test/run-db.c
@@ -176,9 +176,12 @@ int main(int argc, char *argv[])
 	common_setup(argv[0]);
 	ld->config = test_config;
 
-	ok &= test_empty_db_migrate(ld);
-	ok &= test_vars(ld);
-	ok &= test_primitives();
+	/* We do a runtime test here, so we still check compile! */
+	if (HAVE_SQLITE3) {
+		ok &= test_empty_db_migrate(ld);
+		ok &= test_vars(ld);
+		ok &= test_primitives();
+	}
 
 	tal_free(ld);
 	common_shutdown();
diff --git a/wallet/test/run-wallet.c b/wallet/test/run-wallet.c
index 8b927e855..28c7621ec 100644
--- a/wallet/test/run-wallet.c
+++ b/wallet/test/run-wallet.c
@@ -1877,15 +1877,18 @@ int main(int argc, const char *argv[])
 	htlc_in_map_init(&ld->htlcs_in);
 	htlc_out_map_init(&ld->htlcs_out);
 
-	ok &= test_shachain_crud(ld, tmpctx);
-	ok &= test_channel_crud(ld, tmpctx);
-	ok &= test_channel_inflight_crud(ld, tmpctx);
-	ok &= test_channel_config_crud(ld, tmpctx);
-	ok &= test_channel_inflight_crud(ld, tmpctx);
-	ok &= test_wallet_outputs(ld, tmpctx);
-	ok &= test_htlc_crud(ld, tmpctx);
-	ok &= test_payment_crud(ld, tmpctx);
-	ok &= test_wallet_payment_status_enum();
+	/* We do a runtime test here, so we still check compile! */
+	if (HAVE_SQLITE3) {
+		ok &= test_shachain_crud(ld, tmpctx);
+		ok &= test_channel_crud(ld, tmpctx);
+		ok &= test_channel_inflight_crud(ld, tmpctx);
+		ok &= test_channel_config_crud(ld, tmpctx);
+		ok &= test_channel_inflight_crud(ld, tmpctx);
+		ok &= test_wallet_outputs(ld, tmpctx);
+		ok &= test_htlc_crud(ld, tmpctx);
+		ok &= test_payment_crud(ld, tmpctx);
+		ok &= test_wallet_payment_status_enum();
+	}
 
 	/* Do not clean up in the case of an error, we might want to debug the
 	 * database. */
-- 
2.35.1

