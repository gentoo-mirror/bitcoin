From c100de6d938cd9441e4696bab6ad4d4ae2cdbf71 Mon Sep 17 00:00:00 2001
From: ZmnSCPxj jxPCSnmZ <zmnscpxj@protonmail.com>
Date: Mon, 22 Jun 2020 12:15:42 +0800
Subject: [PATCH] common/utils.c: Correctly handle NULL `take`n pointer in
 `tal_dup_talarr`.

Fixes: https://github.com/ElementsProject/lightning/issues/3757

Reported-by: @sumBTC

Changelog-None
---
 common/utils.c    | 7 +++++--
 tests/test_pay.py | 1 -	# omitted from Gentoo (does not apply) -whitslack
 2 files changed, 5 insertions(+), 3 deletions(-)

diff --git a/common/utils.c b/common/utils.c
index 62432f600c..37c4457fc4 100644
--- a/common/utils.c
+++ b/common/utils.c
@@ -142,9 +142,12 @@ void tal_arr_remove_(void *p, size_t elemsize, size_t n)
     tal_resize((char **)p, len - elemsize);
 }
 
-void *tal_dup_talarr_(const tal_t *ctx, const tal_t *src, const char *label)
+void *tal_dup_talarr_(const tal_t *ctx, const tal_t *src TAKES, const char *label)
 {
-	if (!src)
+	if (!src) {
+		/* Correctly handle TAKES on a NULL `src`.  */
+		(void) taken(src);
 		return NULL;
+	}
 	return tal_dup_(ctx, src, 1, tal_bytelen(src), 0, label);
 }
